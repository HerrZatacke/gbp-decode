# gbp-decode
A set of functions to decode gameboy printer code generated by [mofosyne's arduino gameboy printer emulator](https://github.com/mofosyne/arduino-gameboy-printer-emulator)

## Install
Install this module in your existing js application with `npm install --save gbp-decode`
  
## Overwiew
This package exports these functions which are designed to be used in a promise chain:
* [`toByteArray`](#toByteArray)
* [`parsePackets`](#parsePackets)
* [`getImageDataStream`](#getImageDataStream)
* [`decompressDataStream`](#decompressDataStream)
* [`decodePrintCommands`](#decodePrintCommands)
* [`harmonizePalettes`](#harmonizePalettes)
* [`transformToClassic`](#transformToClassic)

It also exports the helpers
* [`unpack`](#unpack)
* [`parsePaletteByte`](#parsePaletteByte)
* [`harmonizePalette`](#harmonizePalette)

An example of how to read a file and transform it can be found here [`src/index.js`](src/index.js)

### toByteArray
[`toByteArray`](src/toByteArray.js) takes a string read from a file (or provided by some other ways of input) and strips all comments (lines starting with `//``).  
It returns an array of bytes (is js Number) which should be looking like this:  
```
[136, 51, 1, 0, 0, 0, 1, 0, 129, 0, 136, 51, 4, 0, ...]
```
> Note the first two entries are `136` and `51` which are the two starting indicators of a printer package (`0x88` and `0x33`)  

### parsePackets
[`parsePackets`](src/parsePackets.js) accepts the result of [`toByteArray`](#toByteArray).  
It returns an array of actual data packets which can be separately parsed.    
Each packet is shaped like this:  
```
{
  command: 1,
  data: [],
  hasCompression: 0,
  dataLength: 0,
  checksum: 1
},
```
> Note: To get from the 'readable' filedata to an actual bytestream check [`src/loadBytes.js`](src/loadBytes.js).  
> The part reading the file (using nodjs's `fs` object) is not being exported in the node module, as this could collide with usage in webpack based projects  
 
### getImageDataStream
[`getImageDataStream`](src/getImageDataStream.js) accepts the result of [`parsePackets`](#parsePackets)  
It returns an array of packets which are _print_ `0x2` or _data_ `0x4` packets. Other packets (_init_ `0x1` and _status_ `0xf`) are removed.  

### decompressDataStream
[`decompressDataStream`](src/decompressDataStream.js) accepts the result of [`getImageDataStream`](#getImageDataStream)  
In all _data_ `0x4` packets it checks for the `hasCompression` flag and if present replaces the compressed content of `data` with the value returned by [`unpack`](#unpack).  
It returns an array of packets in which compressed packets are now uncompressed.  

### decodePrintCommands
[`decodePrintCommands`](src/decodePrintCommands.js) accepts the result of [`decompressDataStream`](#decompressDataStream)  
In all _print_ `0x2` packets the `data` property is transformed to hold the parsed information of the print command.  
The `palette` byte is passed to [`parsePaletteByte`](#parsePaletteByte) to get the parsed palette info.  
``` javascript
{
  "margins": 19, // original value of command (upper and lower nibble)
  "marginUpper": 1, // upper nibble of margin
  "marginLower": 3, // lower nibble of margin
  "palette": 228, // original palette value
  "paletteData": [3, 2, 1, 0] // parsed palette data
}
```
It returns an array of packets in which the _print_ packets hold more information  

### harmonizePalettes
[`harmonizePalettes`](src/harmonizePalettes.js) accepts the result of [`decodePrintCommands`](#decodePrintCommands)  
Applies palette harmonization to all packets by calling [`harmonizePalette`](#harmonizePalette) on each _data_ packet with the `palette` value of the next following _print_ packet    
It returns an array in which all image data follows the 'default' palette.  

### transformToClassic
[`transformToClassic`](src/transformToClassic.js) accepts the result of [`harmonizePalettes`](#harmonizePalettes)  
It returns an array of array representing an image where each line can be handled as a default gameboy tile: 
```
[
  [
    'ff ff ff ff fe ff fe fe fe fe fe fe fe fe fe fe',
    'ff ff ff ff 1c ff 3e 1c 0c 1c 04 0c 0c 04 24 04',
    ...
  ],
  ...
]
```

### unpack
[`unpack`](src/unpack.js) decompresses the simple RLE of a compressed data packet as [documented here](https://shonumi.github.io/articles/art2.html) 

### parsePaletteByte
[`parsePaletteByte`](src/parsePaletteByte.js) 

### harmonizePalette
[`harmonizePalette`](src/harmonizePalette.js) returnes image data of a packet so that the 'default' palette is used.  
Parsing/applying palette data is [documented here in ยง 5.7](https://www.mikrocontroller.net/attachment/34801/gb-printer.txt)

## Resources used:
* https://shonumi.github.io/articles/art2.html  
* https://www.mikrocontroller.net/attachment/34801/gb-printer.txt  
